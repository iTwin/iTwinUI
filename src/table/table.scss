// Copyright (c) Bentley Systems, Incorporated. All rights reserved.
// See LICENSE.md in the project root for license terms and full copyright notice.
@import '../style/index';
@import '../icon/index';
@import './variables';

@mixin iui-table {
  @include iui-reset;
  display: flex;
  flex-direction: column;
  isolation: isolate;

  * {
    box-sizing: border-box;
  }

  @include iui-table-cell-icon;
}

@mixin iui-table-header {
  user-select: none;
  overflow: hidden;
  // Fix for Firefox columns misalignment
  @supports not (overflow: overlay) {
    overflow-y: scroll;
  }
  flex-shrink: 0;
  background-color: var(--iui-color-background-3);

  .iui-row {
    display: flex;
    flex-grow: 1;
    border-left: solid 1px transparent;
    border-right: solid 1px transparent;
  }

  .iui-cell:not(.iui-slot) {
    @include iui-focus;
    flex-wrap: wrap;
    column-gap: $iui-xs;

    &.iui-actionable {
      cursor: pointer;
    }

    &.iui-grabbing {
      cursor: grabbing;
    }

    .iui-filter-button {
      margin-right: $iui-s;

      &:not(.iui-active) {
        visibility: hidden;
      }
    }

    > .iui-resizer {
      height: 100%;
      width: $iui-m;
      position: absolute;
      top: 0;
      right: 0;
      transform: translateX(50%);
      touch-action: none;
      cursor: ew-resize;
      z-index: 1;
      opacity: 0;

      > .iui-resizer-bar {
        height: 100%;
        width: $iui-xxs;
        margin: 0 auto;
        @media (prefers-reduced-motion: no-preference) {
          transition: background-color $iui-speed-fast ease-out, width $iui-speed-fast ease-out;
        }
        background-color: var(--iui-color-background-border);
      }

      &:hover > .iui-resizer-bar {
        width: $iui-xs;
        background-color: var(--iui-color-foreground-primary);
      }
    }

    &:hover > .iui-resizer {
      opacity: 1;
    }

    &:hover,
    &:focus,
    &:focus-within {
      background-color: var(--iui-color-background-4);

      .iui-sort,
      .iui-filter-button {
        visibility: visible;
      }
    }
  }

  .iui-reorder-bar {
    position: absolute;
    height: 100%;
    width: $iui-xxs;
  }

  .iui-reorder-column-right {
    > .iui-reorder-bar {
      right: 0;
    }
  }

  .iui-reorder-column-left {
    > .iui-reorder-bar {
      left: 0;
    }
  }

  .iui-reorder-column-left,
  .iui-reorder-column-right {
    > .iui-reorder-bar {
      background-color: var(--iui-color-foreground-primary);
    }
  }

  // Sort icon
  .iui-sort {
    visibility: hidden;
    fill: var(--iui-icons-color);
  }

  // Sorted column
  .iui-sorted {
    background-color: var(--iui-color-background-4);

    .iui-sort {
      visibility: visible;
      fill: var(--iui-icons-color-actionable);
    }
  }
}

@mixin iui-table-header-actions-container {
  display: flex;
  flex-grow: 1;
  align-items: center;
}

@mixin iui-table-body {
  overflow-y: scroll;
  overflow: overlay;
  display: flex;
  flex-direction: column;
  flex-grow: 1;
  // Allows columns with static width to take more space than the table width
  align-items: flex-start;
  @include iui-scroll-snapping('.iui-row');
  background-color: var(--iui-color-background-1);

  &.iui-zebra-striping .iui-row:nth-child(even):not(.iui-selected) {
    background-color: rgba(var(--iui-color-foreground-body-rgb), 0.02);
  }

  .iui-row {
    min-width: 100%;
    display: flex;
    border: solid 1px transparent;
    @media (prefers-reduced-motion: no-preference) {
      transition: border $iui-speed-fast ease-out;
    }
    border-bottom-color: var(--iui-color-background-border);

    > .iui-slot > .iui-more-options {
      visibility: hidden;
    }

    &:hover:not(.iui-disabled) {
      &:not(.iui-expanded-content) {
        background-color: rgba(var(--iui-color-foreground-primary-rgb), var(--iui-opacity-6));
      }

      > .iui-slot:not(.iui-disabled) > .iui-more-options {
        visibility: visible;
      }
    }

    &:focus-within > .iui-slot:not(.iui-disabled) > .iui-more-options {
      visibility: visible;
    }

    .iui-row-expander > .iui-button-icon {
      @media (prefers-reduced-motion: no-preference) {
        transition: transform $iui-speed-fast ease-out;
      }
    }

    &.iui-row-expanded {
      overflow: hidden;
      border-left-color: var(--iui-color-background-4);
      border-right-color: var(--iui-color-background-4);
      border-bottom-color: transparent;

      .iui-row-expander > .iui-button-icon {
        transform: rotate(90deg);
      }

      + .iui-expanded-content {
        border-left-color: var(--iui-color-background-4);
        border-right-color: var(--iui-color-background-4);
      }
    }

    &.iui-expanded-content {
      overflow: hidden;
      @include iui-transition-group;
    }

    // #region Selection
    &:not(.iui-selected) + .iui-selected,
    &.iui-selected:first-child {
      border-bottom-color: transparent;
    }

    &.iui-selected {
      border-color: var(--iui-color-foreground-primary);
      background: rgba(var(--iui-color-foreground-primary-rgb), var(--iui-opacity-6));

      + .iui-selected {
        border-bottom-color: transparent;
        border-top-color: rgba(var(--iui-color-foreground-primary-rgb), var(--iui-opacity-4));
      }

      &:last-child {
        border-bottom-color: var(--iui-color-foreground-primary);
      }

      + :not(.iui-selected),
      + .iui-expanded-content + :not(.iui-selected) {
        border-top-color: var(--iui-color-foreground-primary);
      }

      + .iui-expanded-content {
        border-color: transparent var(--iui-color-foreground-primary);

        &:last-child {
          border-bottom-color: var(--iui-color-foreground-primary);
        }
      }
    }
    // #endregion Selection

    // #region Statuses & states
    &.iui-new {
      font-weight: $iui-font-weight-semibold;

      > .iui-main-column::before {
        content: 'â€¢';
        position: absolute;
        left: 0;
        font-size: $iui-font-size-title;
        color: var(--iui-color-foreground-positive);
      }
    }

    .iui-cell.iui-disabled,
    &.iui-expanded-content.iui-disabled {
      font-style: italic;
      cursor: not-allowed;
      color: var(--iui-text-color-muted);

      &.iui-slot:hover > .iui-more-options {
        visibility: hidden;
      }

      img,
      svg:not(.iui-radial),
      .iui-avatar {
        filter: $iui-icons-color-multicolor-disabled;
      }
    }

    &.iui-positive {
      @include iui-table-row-status($status: positive);
    }

    &.iui-warning {
      @include iui-table-row-status($status: warning);
    }

    &.iui-negative {
      @include iui-table-row-status($status: negative);
    }
    // #endregion Statuses & states
  }

  // Empty & loading states
  > .iui-table-empty {
    text-align: center;
    padding: $iui-xl;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    flex-grow: 1;
    align-self: center;
    color: var(--iui-text-color-muted);
    background-color: var(--iui-color-background-1);
  }
}

@mixin iui-table-cell {
  align-items: center;
  display: flex;
  flex-grow: 1;
  min-width: $iui-xxl;
  min-height: $iui-baseline * 5;
  padding-left: $iui-m;
  flex-basis: $iui-xxl;
  position: relative;
  word-break: break-word;

  &.iui-slot {
    width: $iui-l * 2;
    padding: 0;
    flex-grow: 0;
    min-width: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-basis: $iui-l * 2;
  }

  &:not(.iui-slot):last-child {
    padding-right: $iui-m;
  }

  &.iui-positive {
    @include iui-table-cell-status($status: positive);
  }

  &.iui-warning {
    @include iui-table-cell-status($status: warning);
  }

  &.iui-negative {
    @include iui-table-cell-status($status: negative);
  }

  &[contenteditable] {
    outline-offset: -1px;

    &:focus,
    &:hover {
      outline: 1px solid var(--iui-color-foreground-primary);
    }

    &:focus {
      background-color: var(--iui-color-background-1);
    }
  }
}

@mixin iui-table-row-status($status) {
  &,
  + .iui-expanded-content {
    box-shadow: inset $iui-xxs 0 0 0 var(--iui-icons-color-#{$status});
    @include iui-text-selection($status);
  }

  .iui-cell-end-icon svg {
    fill: var(--iui-icons-color-#{$status});
  }
}

@mixin iui-table-cell-status($status) {
  background-color: rgba(var(--iui-color-foreground-#{$status}-rgb), var(--iui-opacity-6));
  @include iui-text-selection($status);
}

@mixin iui-table-cell-icon {
  .iui-cell-end-icon,
  .iui-cell-start-icon {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;

    svg:not(.iui-radial) {
      display: flex; // needed for vertical alignment of webcomponents
      width: $iui-icons-default;
      height: $iui-icons-default;
    }
  }

  .iui-cell-start-icon {
    margin-right: $iui-s;
  }

  .iui-cell-end-icon {
    width: $iui-l;
    height: $iui-l;
    margin-right: $iui-sm;
    margin-left: auto;
  }
}
