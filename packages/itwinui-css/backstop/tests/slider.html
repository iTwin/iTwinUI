<!--
  Copyright (c) Bentley Systems, Incorporated. All rights reserved.
  See LICENSE.md in the project root for license terms and full copyright notice.
-->

<!DOCTYPE html>
<html
  lang="en-US"
  id="theme"
>
  <head>
    <meta charset="UTF-8">
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1"
    >
    <title>Slider | iTwinUI</title>
    <link
      rel="stylesheet"
      href="../../css/all.css"
    />
    <link
      rel="stylesheet"
      href="../assets/demo.css"
    />
    <style>
      section[id^='demo'] {
        width: auto;
      }

      /* Gives left & right labels an equal width so the slider is centered. */
      .iui-slider-min,
      .iui-slider-max {width: 25px;}

      .iui-tooltip {
        display: none;
      }

      .iui-slider-container .iui-slider-thumb:focus + .iui-tooltip,
      .iui-slider-container .iui-slider-thumb:hover + .iui-tooltip,
      .iui-slider-container .iui-slider-thumb.iui-active + .iui-tooltip {
        position: absolute;
        display: block;
        margin-top: -32px;
        transform: translateX(-50%);
      }
    </style>

    <script
      type="module"
      src="https://cdn.skypack.dev/@itwin/itwinui-icons-elements/sound-mute"
    ></script>
    <script
      type="module"
      src="https://cdn.skypack.dev/@itwin/itwinui-icons-elements/sound-loud"
    ></script>

    <script src="../assets/theme.js"></script>
  </head>

  <body class="iui-body">
    <theme-button></theme-button>
    <h1>Slider</h1>
    <hr />
    <br>

    <!-- TODO: Re-add deleted example horizontal sliders -->

    <h2>Default vertical</h2>
    <section id="demo-default-vertical">
      <div class="iui-input-container">
        <div class="iui-label">Volume</div>

        <div
          class="iui-slider-component-container iui-vertical iui-input-group"
          style="height: 500px;"
        >
          <span class="iui-slider-min">
            <svg-sound-mute
              class="iui-icon"
              aria-hidden="true"
            ></svg-sound-mute>
          </span>
          <div class="iui-slider-container iui-progress-slider">
            <div class="iui-slider-rail"></div>
            <div
              class="iui-slider-track"
              style="bottom: 50%;"
            ></div>
            <div
              style="bottom: 50%;"
              class="iui-slider-thumb"
              role="slider"
              tabindex="0"
              aria-label="Volume Setting"
              aria-valuemin="0"
              aria-valuenow="50"
              aria-valuemax="100"
              id="test-slider-1"
            ></div>
            <output
              class="iui-tooltip"
              style="bottom: 50%;"
            >
              50
            </output>
          </div>
          <span class="iui-slider-max">
            <svg-sound-loud
              class="iui-icon"
              aria-hidden="true"
            ></svg-sound-loud>
          </span>
        </div>

      </div>
    </section>

    <script>

      function setTooltip(percent, tooltip) {
        if (tooltip) {
          tooltip.style.left = `${percent}%`;
          tooltip.innerHTML = `${percent}`;
        }
      }

      function setTooltipVertical(percent, tooltip) {
        // setTooltip(percent, tooltip);
        // return;

        if (tooltip) {
          tooltip.style.top = `${percent}%`;
          tooltip.innerHTML = `${percent}`;
        }
      }

      function getMinValueFromThumb(thumb) {
        const minAtt = thumb.getAttribute("aria-valuemin");
        const dataRangeMinAtt = thumb.getAttribute("data-range-min");
        const min = parseInt(null !== dataRangeMinAtt ? dataRangeMinAtt : minAtt);
        return min;
      }

      function getMaxValueFromThumb(thumb) {
        const maxAtt = thumb.getAttribute("aria-valuemax");
        const dataRangeMaxAtt = thumb.getAttribute("data-range-max");
        const max = parseInt(null !== dataRangeMaxAtt ? dataRangeMaxAtt : maxAtt);
        return max;
      }

      function getMaxLimitValueFromThumb(thumb) {
        var maxAtt = thumb.getAttribute("aria-valuemax");
        var max = parseInt(maxAtt);
        return max;
      }

      function getMinLimitValueFromThumb(thumb) {
        var minAtt = thumb.getAttribute("aria-valuemin");
        var min = parseInt(minAtt);
        return min;
      }

      function getPercentFromThumb(thumb) {
        var valueAtt = thumb.getAttribute("aria-valuenow");
        var value = parseInt(valueAtt);
        var min = getMinValueFromThumb(thumb);
        var max = getMaxValueFromThumb(thumb);
        var percent = ((value - min) / (max - min)) * 100;
        return percent;
      }

      function moveSlider(event, thumb, track, progress, mode, toolTip, otherThumb) {
        var min = getMinValueFromThumb(thumb);
        var limitMin = getMinLimitValueFromThumb(thumb);
        var max = getMaxValueFromThumb(thumb);
        var limitMax = getMaxLimitValueFromThumb(thumb);
        var rect = track.getBoundingClientRect();
        var trackWidth = rect.width;
        var diffX = event.pageX - rect.left;
        if (diffX > rect.width)
          diffX = rect.width;
        if (diffX < 0)
          diffX = 0;

        var percent = parseInt(((max - min) * diffX) / trackWidth);
        if (percent < limitMin)
          percent = limitMin;
        if (percent > limitMax)
          percent = limitMax;

        thumb.setAttribute("aria-valuenow", percent);
        setTooltip(percent, toolTip);
        if (mode === "progress") {
          thumb.style.left = `${percent}%`;
          var progressPercent = 100 - percent;
          progress.style.right = `${progressPercent}%`;
        } else if (mode === "range-left") {
          otherThumb && otherThumb.setAttribute("aria-valuemin", percent + 1);
          thumb.style.left = `${percent}%`;
          progress.style.left = `${percent}%`;
        } else if (mode === "range-right") {
          otherThumb && otherThumb.setAttribute("aria-valuemax", percent - 1);
          thumb.style.left = `${percent}%`;
          var progressPercent = 100 - percent;
          progress.style.right = `${progressPercent}%`;
        }

        event.preventDefault();
        event.stopPropagation();
      }

      function moveSliderVertical(event, thumb, track, progress, mode, toolTip, otherThumb) {
        // console.log("event.pageY", event.pageY);

        var min = getMinValueFromThumb(thumb);
        var limitMin = getMinLimitValueFromThumb(thumb);
        var max = getMaxValueFromThumb(thumb);
        var limitMax = getMaxLimitValueFromThumb(thumb);

        // console.log("VALUES: ", min, limitMin, max, limitMax);

        var rect = track.getBoundingClientRect();
        // var trackWidth = rect.width;
        var trackHeight = rect.height;
        // var diffX = event.pageX - rect.left;
        // var diffY = event.pageY - rect.top;
        // var diffY = event.pageX - 541.5;
        // var diffY = event.offsetY - rect.top;
        // var diffY = event.offsetY;
        // var diffY = event.pageX - rect.left;
        var diffY = event.pageY - rect.top;
        console.log(rect.top, rect.bottom, event.pageY);

        // console.log("VALUES: ", event.pageY, rect.top, diffY, event.offsetY, event.screenY);
        // console.log("VALUES: ", event.pageY, event.offsetY, event.screenY, rect.top, diffY);
        // console.log(rect);

        if (diffY > rect.height)
          diffY = rect.height;
        if (diffY < 0)
          diffY = 0;

        var percent = parseInt(((max - min) * diffY) / trackHeight);
        if (percent < limitMin)
          percent = limitMin;
        if (percent > limitMax)
          percent = limitMax;

        thumb.setAttribute("aria-valuenow", percent);
        setTooltipVertical(percent, toolTip);
        if (mode === "progress") {
          thumb.style.top = `${percent}%`;
          var progressPercent = 100 - percent;
          progress.style.bottom = `${progressPercent}%`;
        }
        // else if (mode === "range-left") {
        //   otherThumb && otherThumb.setAttribute("aria-valuemin", percent + 1);
        //   thumb.style.left = `${percent}%`;
        //   progress.style.left = `${percent}%`;
        // } else if (mode === "range-right") {
        //   otherThumb && otherThumb.setAttribute("aria-valuemax", percent - 1);
        //   thumb.style.left = `${percent}%`;
        //   var progressPercent = 100 - percent;
        //   progress.style.right = `${progressPercent}%`;
        // }

        event.preventDefault();
        event.stopPropagation();
      }

      function getOtherRangeThumb(thumb) {
        var parent = thumb.parentNode;
        const allThumbs = parent.querySelectorAll(".iui-slider-thumb");
        for (var i = 0; i < allThumbs.length; i++) {
          if (allThumbs[i] !== thumb)
            return allThumbs[i];
        }
      }

      function getToolTip(thumb, mode) {
        const parent = thumb.parentNode;
        const tooltips = parent.querySelectorAll(".iui-tooltip");
        if (mode === "range-left")
          return tooltips[0];
        else if (mode === "range-right")
          return tooltips[1];

        return tooltips[0];
      }

      function initializeThumbProcessing(thumb, sliderContainer, mode) {
        const percent = getPercentFromThumb(thumb);
        let progress;
        const toolTip = getToolTip(thumb, mode);

        if (mode === "progress") {
          thumb.style.left = `${percent}%`;
          progress = sliderContainer.querySelector(".iui-slider-track");
          progressPercent = 100 - percent;
          progress.style.right = `${progressPercent}%`;
        } else if (mode === "range-left") {
          thumb.style.left = `${percent}%`;
          progress = sliderContainer.querySelector(".iui-slider-track");
          progress.style.left = `${percent}%`;
        } else if (mode === "range-right") {
          thumb.style.left = `${percent}%`;
          progress = sliderContainer.querySelector(".iui-slider-track");
          progressPercent = 100 - percent;
          progress.style.right = `${progressPercent}%`;
        }

        setTooltip(percent, toolTip);

        // window.addEventListener("mousedown", function () {
        //   var handleMouseMove = function (event) {
        //     var track = sliderContainer.querySelector(".iui-slider-rail");
        //     console.log(track.getBoundingClientRect());
        //     console.log(event.pageX, event.pageY);
        //   };

        //   window.addEventListener("mousemove", handleMouseMove);
        //   window.addEventListener("mouseup", function () {
        //     window.removeEventListener("mousemove", handleMouseMove);
        //   });
        // });

        thumb.addEventListener("mousedown", function () {
          if (sliderContainer.parentElement.classList.contains('iui-disabled'))
            return;
          thumb.classList.add("iui-active");
          sliderContainer.classList.add("iui-grabbing");
          var otherThumb = getOtherRangeThumb(thumb);
          var ownerDoc = thumb.ownerDocument;
          var track = sliderContainer.querySelector(".iui-slider-rail");
          var handleMouseMove = function (event) {
            // moveSlider(event, thumb, track, progress, mode, toolTip, otherThumb);
            moveSliderVertical(event, thumb, track, progress, mode, toolTip, otherThumb);
          };

          var handleMouseUp = function (event) {
            ownerDoc.removeEventListener('mousemove', handleMouseMove);
            ownerDoc.removeEventListener('mouseup', handleMouseUp);
            thumb.classList.remove("iui-active");
            sliderContainer.classList.remove("iui-grabbing");
          };

          // bind a mousemove event handler to move pointer
          ownerDoc.addEventListener('mousemove', handleMouseMove);

          // bind a mouseup event handler to stop tracking mouse movements
          ownerDoc.addEventListener('mouseup', handleMouseUp);

          event.preventDefault();
          event.stopPropagation();
        });
      }

      function initializeAllProgressSliders() {
        const allProgressSliderContainers = document.querySelectorAll(".iui-slider-container.iui-progress-slider");
        allProgressSliderContainers.forEach(progressSliderContainer => {
          const thumb = progressSliderContainer.querySelector(".iui-slider-thumb");
          initializeThumbProcessing(thumb, progressSliderContainer, "progress");
        });
      }

      function initializeAllRangeSliders() {
        const allRangeSliderContainers = document.querySelectorAll(".iui-slider-container.iui-range-slider");
        allRangeSliderContainers.forEach(rangeSliderContainer => {
          const thumbs = rangeSliderContainer.querySelectorAll(".iui-slider-thumb");

          const leftThumb = thumbs[0];
          if (leftThumb) {
            initializeThumbProcessing(leftThumb, rangeSliderContainer, "range-left");
          }

          const rightThumb = thumbs[1];
          if (rightThumb) {
            initializeThumbProcessing(rightThumb, rangeSliderContainer, "range-right");
          }
        });
      }

      initializeAllProgressSliders();
      initializeAllRangeSliders();
    </script>
  </body>
</html>
